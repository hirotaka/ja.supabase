---
id: api
title: API
description: APIの自動生成とリアルタイムAPI
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

## 概要

Supabaseはデータベースのスキーマから直接3つのタイプのAPIを生成します。

- REST - レストフルなインターフェースでやりとり
- Realtime - データベースの更新をリッスン
- GraphQL - [ベータ版](/blog/2021/12/03/pg-graphql)

これらのAPIは次の特徴があります。

- **即時性と自動生成** <br />データベースを更新すると、その変更内容がAPIを通じてすぐアクセス可能になります。
- **ドキュメントの生成** <br />Supabaseは、データベースを変更した際、ダッシュボードに更新されたドキュメントを生成します。
- **セキュア** <br />APIはPostgreSQLの行単位セキュリティーと連動するように設定されており、APIゲートウェイの背後でキーによる認証が有効になっています。
- **高速** <br />基本的な読み込みのベンチマークでは、Firebaseと比較して300%以上の高速化を実現しています。APIはPostgres上の非常に薄い層であり、Postgresがほとんどの力仕事をします。
- **スケーラブル** <br />APIは数千の同時リクエストに対応しており、サーバレスの処理にも適しています。

### REST API 

Supabaseは、[PostgREST](https://postgrest.org/)を用いたRESTfulなAPIを提供しています。これは、Postgresの上の非常に薄いAPI層です。
これは、CRUDのAPIに必要なすべてを提供します。

- 基本的なCRUD操作
- 深くネストされた結合により、1回のフェッチで複数のテーブルからデータを取得可能
- Potgresのビューと連動
- Postgresの関数と連動
- 行単位セキュリティー、ロール、およびGRANTなどの、Postgresのセキュリティモデルと連動

<iframe
  className="w-full video-with-border"
  width="640"
  height="480"
  src="https://www.youtube-nocookie.com/embed/rPAJJFdtPw0"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

### GraphQL API

:::note

GraphQLはベータ版であり、変更される可能性があります。2022年3月28日以降に作成されたセルフ・ホストでのセットアップとSupabaseプロジェクトでのみ利用可能です。 

:::

SupabaseのGraphQLは、GraphQLのためのオープンソースのPostgreSQL拡張である[pg_graphql](/blog/2021/12/03/pg-graphql)を通じて機能します。 

### リアルタイムAPI

Supabaseは[Realtime](https://github.com/supabase/realtime)を使って、リアルタイムAPIを提供しています。これを利用して、データベースの変更をWebSocketで待ち受けることができます。
RealtimeはPostgreSQLに組み込まれた論理的なレプリケーションを利用しています。Postgresのパブリケーションを管理するだけで、リアルタイムAPIを管できますす。

## はじめに

すべてのAPIは、データベースのテーブルから自動作成されます。データベースにテーブルや関数を追加した後、提供されるAPIを使用できます。 

### APIルートの作成

APIルートは、Postgresのテーブル、ビュー、または関数を作成する際、自動的に作成されます。

最初のAPIルートを作成するために、`todos`というテーブル（いくつかユーザーのパブリックな情報を保存します）を作成しましょう。
これにより、`GET`、`POST`、`PATCH`、`DELETE`のリクエストを受け付けることができる、`todos`に対応したルートが作成されます。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

```sh
1. 「Table Editor」セクションに移動します。
2. 「New Table」をクリックします。
3. 「todos」というテーブル名を入力します。
4. 「Save」をクリックします。
5. 「New Column」をクリックします。
6. 「task」というカラム名を入力し、タイプを「text」にします。
7. 「Sava」をクリックします。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-create-table-sm.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="SQL">

```sql
-- タスクを格納する列を持つ「todos」というテーブルを作成します。

create table todos (
  id bigint generated by default as identity primary key,
  task text check (char_length(task) > 3)
);
```

</TabItem>
</Tabs>

### API URLとキー

Supabaseの各プロジェクトには、固有のAPI URLがあります。APIはAPIゲートウェイで保護されており、リクエストごとにAPIキーが必要となります。


```sh
1. 「Settings」セクションに移動します。
2. サイドバーの「API」をクリックします。
3. そのページ内で、API URLを探します。
4. そのページ内で、「anon」と「service_role」キーを探します。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-url-and-key.mp4" type="video/mp4" muted playsInline />
</video>

REST APIとGraphQL APIは、どちらも次のURLよりアクセスできます。 

- REST: `https://<project_ref>.supabase.co/rest/v1`
- GraphQL: `https://<project_ref>.supabase.co/graphql/v1`

これらのルートはどちらも`anon`キーが`apikey`ヘッダーを通して渡されることを必要があります。

#### APIキー


キーは、ダッシュボード内の、上記URLと同じ場所にあります。

鍵は2つ用意されています。

- `anon`キーはブラウザのコンテキストで使用しても安全です。
- `service_role`キーはサーバー上でのみ使用します。このキーは行単位セキュリティーを回避できます。


### ドキュメントへのアクセス

#### REST API

Supabaseは、データベースの変更に応じてドキュメントを更新して、ダッシュボードに生成します。
最初のステップで作成した`todos`テーブルのドキュメントを見てみましょう。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'}
]}>
<TabItem value="UI">

```sh
1. 「API」セクションに移動します。
2. 「Tables and views」セクションで「todos」を探します。
3. タブを使用して、JavascriptとcURLのドキュメントを切り替えます。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-docs.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
</Tabs>

#### GraphQL 

<<<<<<< HEAD
GraphQLエンドポイント（`https://<project_ref>.supabase.com/rest/v1`）は、`apikey`ヘッダーを渡すことができるGraphiQL実装と互換性があります。
いくつかの推奨アプリケーションを次に紹介します。
=======
The GraphQL Endpoint that we provide (`https://<project_ref>.supabase.co/rest/v1`) is compatible with any GraphiQL implementation that can pass an `apikey` header.
Some suggested applications:
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

- [paw.cloud](https://paw.cloud)
- [insomnia.rest](https://insomnia.rest)
- [postman.com/graphql](https://www.postman.com/graphql/)
- セルフホスティングのGraphiQL：GraphiQLはシンプルなHTMLファイルを通して提供できます。詳しくは[こちらのDiscussion](https://github.com/supabase/supabase/discussions/6144)を参照

## APIの利用


### REST API

HTTPリクエストを介してAPIを直接操作できますし、当社が提供するクライアント・ライブラリーを使用できます。

<!-- textlint-disable ja-technical-writing/sentence-length -->
それでは、最初のステップで作成した`todos`テーブルに、取得したAPI URL（`[SUPABASE_URL]`）とキー（`[SUPABASE_ANON_KEY]`）を使ってリクエストする方法を見てみましょう。
<!-- textlint-enable ja-technical-writing/sentence-length -->


<Tabs
defaultValue="Javascript"
values={[
  {label: 'Javascript', value: 'Javascript'},
  {label: 'cURL', value: 'cURL'},
]}>
<TabItem value="Javascript">

```javascript
// JSクライアントを初期化
import { createClient } from '@supabase/supabase-js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// リクエストを作成
let { data: todos, error } = await supabase
  .from('todos')
  .select('*')
```

</TabItem>
<TabItem value="cURL">

```bash
# URLに/rest/v1/を追加して、テーブル名をルートとして使用
curl '[SUPABASE_URL]/rest/v1/todos' \
-H "apikey: [SUPABASE_ANON_KEY]" \
-H "Authorization: Bearer SUPABASE_ANON_KEY"
```

</TabItem>
</Tabs>

<!-- textlint-disable ja-technical-writing/max-comma -->
- JSリファレンス：[select()](/docs/reference/javascript/select),
[insert()](/docs/reference/javascript/insert),
[update()](/docs/reference/javascript/update),
[upsert()](/docs/reference/javascript/upsert),
[delete()](/docs/reference/javascript/delete),
[rpc()](/docs/reference/javascript/rpc)（Postgresの関数呼び出し）
<!-- textlint-enable ja-technical-writing/max-comma -->


### GraphQL API

:::note 

SQLスキーマからGraphQLスキーマを再構築するには、`select graphql.rebuild_schema();`を呼び出します。
SQLスキーマを変更した後は、必ずGraphQLスキーマを再構築するようにしてください。

:::

Supabase GraphQL APIでは、任意のGraphQLクライアントを使用できます。今回のGraphQLの例では、[urlql](https://formidable.com/open-source/urql/docs/)を使用することにします。 

<Tabs
defaultValue="Javascript"
values={[
  {label: 'Javascript', value: 'Javascript'},
  {label: 'cURL', value: 'cURL'},
]}>
<TabItem value="Javascript">

```javascript
import { createClient, useQuery } from 'urql'

// Prepare API key and Authorization header
const headers = {
  apikey: <SUPABASE_ANON_KEY>,
  authorization: `Bearer: ${<SUPABASE_ANON_KEY}`>
}

// Create GraphQL client
// See: https://formidable.com/open-source/urql/docs/basics/react-preact/#setting-up-the-client
const client = createClient({
  url: '<SUPABASE_URL>/grapqhl/v1',
  fetchOptions: function createFetchOptions() { 
    return { headers }
  },
})

// Prepare our GraphQL query
const TodosQuery = `
  query {
    todosCollection {
      edges {
        node {
          id
          title
        }
      }
    }
  }
`

// Query for the data (React)
const [result, reexecuteQuery] = useQuery({
  query: TodosQuery,
})

// Read the result
const { data, fetching, error } = result
```
</TabItem>
<TabItem value="cURL">

```bash
# Append /grapqhl/v1/ to your URL, and then use the table name as the route
curl --request POST '<SUPABASE_URL>/grapqhl/v1' \
-H 'apikey: <SUPABASE_ANON_KEY>' \
-H 'Authorization: Bearer <SUPABASE_ANON_KEY>' \
-d '{ "query":"{ todos(first: 3) { edges { node { id } } } }" }'
```


</TabItem>
</Tabs>


### リアルタイムの管理

デフォルトでは、データベースのリアルタイムは無効になっています。それでは、`todos`テーブルのリアルタイムを有効にしてみましょう。

:::note

Realtime only works for tables in theパブリック・スキーマ。

:::

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

```sh
1. 「Database」セクションに移動します。
2. サイドバーの「Replication」をクリックします。
3. Insert/Update/Deleteのトグルを切り替えることで、どのデータベース・イベントを送信するか制御します。
4. 「Source」をクリックしてテーブルを切り替えることで、どのテーブルの変更を反映するか制御できます。
```

<video width="99%" muted playsInline controls="true">
<source src="/docs/videos/api/api-realtime.mp4" type="video/mp4" muted playsInline />
</video>

</TabItem>
<TabItem value="SQL">

```sql
alter publication supabase_realtime add table todos;
```

</TabItem>
</Tabs>

<<<<<<< HEAD
これで、`todo`テーブルに挿入される新しいデータをリッスンできるようになりました。
=======
Now we can listen to any new data that is inserted into the `todos` table:
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

<Tabs
defaultValue="Javascript"
values={[
  {label: 'Javascript', value: 'Javascript'}
]}>
<TabItem value="Javascript">

```javascript
// Initialize the JS client
import { createClient } from '@supabase/supabase-js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// Create a function to handle inserts
const handleInserts = (payload) => {
  console.log('Change received!', payload)
}

// Listen to unserts
const { data: todos, error } = await supabase
  .from('todos')
  .on('INSERT', handleUpdates)
  .subscribe()
```

</TabItem>
</Tabs>

データベースの変更をリッスンするには、[subscribe()](/docs/reference/javascript/subscribe)を使用します。 
リアルタイムAPIは、PostgreSQLのレプリケーション機能を介して動作します。Postgresはデータベースの変更を、`supabase_realtime`と呼ばれる「パブリケーション」に送信します。

## APIのセキュリティー


### ルートのセキュア化

APIは、Postgresの行単位セキュリティーと連動するように設計されています。Supabase [Auth](/docs/guides/auth)を使用すれば、ログインしたユーザーに基づいてデータを制限できます。
データへのアクセスを制御するには、[ポリシー](/docs/guides/auth#policies)を使用します。
Postgresでテーブルを作成すると、デフォルトでは行単位セキュリティー（RLS）が無効になっています。[RLSを有効にする](/docs/guides/api#securing-your-routes)ことでセキュリティーを確保してください。

<Tabs
defaultValue="UI"
values={[
  {label: 'UI', value: 'UI'},
  {label: 'SQL', value: 'SQL'},
]}>
<TabItem value="UI">

```sh
1. 「Authentication」セクションに移動します。
2. サイドバーの「Policies」をクリックします。
3. 南京錠をクリックして、行単位セキュリティーを有効にします。
```

</TabItem>
<TabItem value="SQL">

```sql
alter table todos enable row level security;
```

</TabItem>
</Tabs>

### `service_role`キー


ブラウザーやユーザーが見ることのできる場所に`service_role`キーを決して公開しないでください。このキーは行単位セキュリティーをバイパスするように設計されています。したがって、公開されていないサーバーでのみ使用するようにしてください。

[GitHubと提携](/blog/2022/03/28/community-day#supabase-is-now-a-github-secret-scanning-partner)し、Supabaseの`service_role`キーが公開リポジトリーにプッシュされていないかスキャンします。
GitHubがservice_role権限のあるキーを検出すると、そのキーをSupbaseに転送します。Supabaseは自動的にそのキーを失効してお知らせします。それにより、データを悪質業者から保護します。

### 誤って削除や更新をしてしまわないための保護機能

新しいプロジェクトでは、デフォルトで、APIから来るすべてのクエリに対してPostgres拡張機能の[safeupdate](https://github.com/eradman/pg-safeupdate)が有効になっています。 
これにより、付随するフィルターが提供されていない場合に、`delete()`または`update()`が失敗することを保証します。
これを無効にするには、ダッシュボードのSQLエディターで以下のクエリを実行します。
```sql
select usename,useconfig from pg_shadow where usename = 'authenticator' ;
```

useconfig` に期待される値は次のとおりです。
```
["session_preload_libraries=supautils, safeupdate"]
```
