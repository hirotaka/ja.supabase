---
id: functions
title: データベース関数
description: Postgres関数の作成と利用。
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


Postgresには、[SQL関数](https://www.postgresql.org/docs/current/sql-createfunction.html)のサポートが組み込まれています。
これらの関数は、データベース内に存在し、[APIでも使用](/docs/reference/javascript/rpc)できます。

<<<<<<< HEAD
## データベース・ファンクション vs エッジ・ファンクション

データに関する操作には、データベース内で実行され、RESTやGraphQL APIを使用してリモートで呼びだすことができるデータベース・ファンクションをおすすめします。

グローバルに展開されるTypescriptファンクションをお探しの場合は、[エッジ・ファンクション](/docs/guides/functions) を参照してください。

## クイック・デモ
=======
## Quick demo
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

<iframe
  className="w-full video-with-border"
  width="640"
  height="385"
  src="https://www.youtube-nocookie.com/embed/MJZCCpCYEqk"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

<<<<<<< HEAD
## 関数を作成
=======
## Getting started
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

Supabaseは、データベースの関数を作成するためのいくつかの選択肢を提供しています。
ダッシュボードを使用するか、SQLを使用して直接作成できます。ダッシュボードにはSQLエディターが用意されていますが、データベースに[接続](/docs/guides/database/connecting/connecting-to-postgres)して自分でSQLクエリを実行できます。


1. 「SQL editor」セクションに移動します。
2. 「New Query」をクリックします。
3. データベース関数を作成または置き換えるためのSQLを入力します。
4. 「Run」をクリックするか、cmd+enter（ctrl+enter）を入力します。

<<<<<<< HEAD
## 例

### データの集合

このガイドでは、以下の例のデータを使用します。
=======

## Simple Functions

Let's create a basic Database Function which returns a string "hello world".
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

```sql
create or replace function hello_world() -- 1
returns text -- 2
language sql -- 3
as $$  -- 4
  select 'hello world';  -- 5
$$; --6

```

<details>
<summary>Show/Hide Details</summary>
  
At it's most basic a function has the following parts:

1. `create or replace function hello_world()`: The function declaration, where `hello_world` is the name of the function. You can use either `create` when creating a new function or `replace` when replacing an existing function. Or you can use `create or replace` together to handle either.
2. `returns text`: The type of data that the function returns. If it returns nothing, you can `returns void`. 
3. `language sql`: The language used inside the function body. This can also be a procedural language: `plpgsql`, `plv8`, `plpython`, etc.
4. `as $$`: The function wrapper. Anything enclosed inside the `$$` symbols will be part of the function body.
5. `select 'hello world';`: A simple function body. The final `select` statement inside a function body will be returned if there are no statements following it.
6. `$$;`: The closing symbols of the function wrapper.

</details>

<br />

After the Function is created, we have several ways of "executing" the function - either directly inside the database using SQL, or with one of the client libraries.

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'JS', value: 'JS'},
  {label: 'Dart', value: 'Dart'},
]}>

<TabItem value="SQL">

```sql
select hello_world();
```

</TabItem>
<TabItem value="JS">

```js 
const { data, error } = supabase
  .rpc('hello_world')
```

Reference: [rpc()](/docs/reference/javascript/rpc)

</TabItem>
<TabItem value="Dart">

```dart 
final res = await supabase
  .rpc('hello_world')
  .execute();
```

Reference: [rpc()](/docs/reference/dart/rpc)

</TabItem>

</Tabs>


## Returning data sets

Database Functions can also return data sets from [Tables](/docs/guides/database/tables) or Views.

For example, if we had a database with some Star Wars data inside:

<Tabs
defaultValue="Data"
values={[
  {label: 'Data', value: 'Data'},
  {label: 'SQL', value: 'SQL'},
]}>

<TabItem value="SQL">

```sql
create table planets (
  id serial primary key,
  name text
);

insert into planets (id, name) 
values 
  (1, 'Tattoine'),
  (2, 'Alderaan'),
  (3, 'Kashyyyk');

create table people (
  id serial primary key,
  name text,
  planet_id bigint references planets
);

insert into people (id, name, planet_id) 
values 
  (1, 'Anakin Skywalker', 1),
  (2, 'Luke Skywalker', 1),
  (3, 'Princess Leia', 2),
  (4, 'Chewbacca', 3);
```

</TabItem>
<TabItem value="Data">

<h4>Planets（惑星）</h4>

| id    | name | 
| ----  | ---- | 
|    1 | Tattoine | 
|    2 | Alderaan  | 
|    3 | Kashyyyk | 

<h4>People（人々）</h4>

| id    | name | planet_id |
| ----  | ---- | ---- | 
|    1 | Anakin Skywalker | 1 | 
|    2 | Luke Skywalker  | 1 | 
|    3 | Princess Leia | 2 | 
|    4 | Chewbacca | 3 | 

</TabItem>

</Tabs>

<<<<<<< HEAD
### 基本的な関数

「hello world」という文字列を返す基本的な例です。

```sql
create or replace function hello_world() -- 1
returns text -- 2
language sql -- 3
as $$  -- 4
  select 'hello world';  -- 5
$$; --6

```

<details>
<summary>詳細の表示/非表示</summary>

最も基本的な関数は、以下の部分で構成されています。

1. `create or replace function hello_world()`：`hello_world`は関数の名前です。新規に関数を作成する場合は`create`、既存の関数を置き換える場合は`replace`を使用します。また、`create or replace`を一緒に使用することで、どちらかで処理ができます。
2. `return text`：この関数が返すデータの種類です。何も返さない場合は、`return void`にします。
3. `language sql`：関数本体で使用される言語です。`plpgsql`, `plv8`, `plpython`などの手続き型言語も使用できます。
4. `as $$`：関数のラッパーです。`$$`記号で囲まれたものは、関数本体の一部となります。
5. `select 'hello world';`：単純な関数本体です。関数本体内の最後の`select`文は、それに続く文がない場合に返されます。
6. `$$;`：関数ラッパーを閉じるためのシンボルです。

</details>

#### 実行

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'JS', value: 'JS'},
  {label: 'Dart', value: 'Dart'},
]}>

<TabItem value="SQL">

```sql
select hello_world();
```

</TabItem>
<TabItem value="JS">

```js 
const { data, error } = supabase
  .rpc('hello_world')
```

参考：[rpc()](/docs/reference/javascript/rpc)

</TabItem>
<TabItem value="Dart">

```dart 
final res = await supabase
  .rpc('hello_world')
  .execute();
```

参考：[rpc()](/docs/reference/dart/rpc)

</TabItem>

</Tabs>


### テーブルの集合を返す

例のデータの集合に含まれるすべての`planets`を返す基本的な例です。
=======

We could create a function which returns all the planets:
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

```sql
create or replace function get_planets() 
returns setof planets
language sql
as $$
  select * from planets;
$$;
```

<<<<<<< HEAD
#### 実行

この関数はテーブルの集合を返すので、フィルタやセレクターを適用できます。例えば、最初の惑星だけが欲しい場合は次のようにします。
=======
Because this function returns a table set, we can also apply filters and selectors. For example, if we only wanted the first planet:
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'JS', value: 'JS'},
  {label: 'Dart', value: 'Dart'},
]}>

<TabItem value="SQL">

```sql
select *
from get_planets()
where id = 1;
```

</TabItem>
<TabItem value="JS">

```js 
const { data, error } = supabase
  .rpc('get_planets')
  .eq('id', 1)
```

<<<<<<< HEAD
参考：[rpc()](/docs/reference/javascript/rpc)

=======
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2
</TabItem>
<TabItem value="Dart">

```dart 
final res = await supabase
  .rpc('get_planets')
  .eq('id', 1)
  .execute();
```

<<<<<<< HEAD
参考：[rpc()](/docs/reference/dart/rpc)

=======
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2
</TabItem>

</Tabs>


<<<<<<< HEAD
### パラメーター付き

新しい惑星を`planets`に挿入し、新しいIDを返す基本的な例です。今回は`plpgsql`という言語を使っていることに注意してください。
=======
## Passing parameters

Let's create a Function to insert a new planet into the `planets` table and return the new ID. Note that this time we're using the `plpgsql` language.
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

```sql
create or replace function add_planet(name text) 
returns bigint
language plpgsql
as $$
declare 
  new_row bigint;
begin
  insert into planets(name)
  values (add_planet.name)
  returning id into new_row;

  return new_row;
end;
$$;
```

<<<<<<< HEAD
#### 実行

この関数はテーブルの集合を返すので、フィルタやセレクターを適用できます。例えば、最初の惑星の`name`だけが欲しい場合は次のようにします。
=======
Once again, you can execute this function either inside your database using a `select` query, or with the client libraries:
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

<Tabs
defaultValue="SQL"
values={[
  {label: 'SQL', value: 'SQL'},
  {label: 'JS', value: 'JS'},
  {label: 'Dart', value: 'Dart'},
]}>

<TabItem value="SQL">

```sql
select * from add_planet('Jakku');
```

</TabItem>
<TabItem value="JS">

```js 
const { data, error } = await supabase
  .rpc('add_planet', { name: 'Jakku' })
```

<<<<<<< HEAD
参考：[rpc()](/docs/reference/javascript/rpc)
=======
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2

</TabItem>
<TabItem value="Dart">

```dart 
final res = await supabase
  .rpc('add_planet', params: { 'name': 'Jakku' })
  .execute();
```

<<<<<<< HEAD
参考：[rpc()](/docs/reference/dart/rpc)

=======
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2
</TabItem>

</Tabs>


<<<<<<< HEAD
## リソース

- PostgreSQL公式ドキュメント：[第9章 関数と演算子](https://www.postgresql.org/docs/current/functions.html)
- PostgreSQLリファレンス：[CREATE FUNCTION](https://www.postgresql.org/docs/9.1/sql-createfunction.html)
=======
## Suggestions

### Database Functions vs Edge Functions

For data-intensive operations we recommend using [Database Functions](/docs/guides/database/functions), which are executed within your database
and can be called remotely using the [REST and GraphQL API](/docs/guides/database/api).

For use-cases which require low-latency we recommend [Edge Functions](/docs/guides/functions), which are globally-distributed and can be written in Typescript.

### Security `definer` vs `invoker`

Postgres allows you to specify whether you want the function to be executed as the user _calling_ the function (`invoker`), or as the _creator_ of the function (`definer`). For example:

```sql
create function hello_world() 
returns text 
language plpgsql 
security definer set search_path = public
as $$
begin
  select 'hello world';
end;
$$;
```

It is best practice to use `security invoker` (which is also the default). If you ever use `security invoker`, you _must_ set the `search_path`. 
This limits the potential damage if you allow access to schemas which the user executing the function should not have.

## Resources


- Official Client libraries: [JavaScript](/docs/reference/javascript/rpc) and [Dart](/docs/reference/dart/rpc)
- Community client libraries: [github.com/supabase-community](https://github.com/supabase-community)
- PostgreSQL Official Docs: [Chapter 9. Functions and Operators](https://www.postgresql.org/docs/current/functions.html)
- PostgreSQL Reference: [CREATE FUNCTION](https://www.postgresql.org/docs/9.1/sql-createfunction.html)

## Deep Dive 

### Create Database Functions

<iframe
  className="w-full video-with-border"
  width="640"
  height="385"
  src="https://www.youtube-nocookie.com/embed/MJZCCpCYEqk"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

### Call Database Functions using JavaScript

<iframe
  className="w-full video-with-border"
  width="640"
  height="385"
  src="https://www.youtube-nocookie.com/embed/I6nnp9AINJk"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>

### Using Database Functions to call an external API

<iframe
  className="w-full video-with-border"
  width="640"
  height="385"
  src="https://www.youtube-nocookie.com/embed/I6nnp9AINJk"
  frameBorder="1"
  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
  allowFullScreen
></iframe>
>>>>>>> 9609dae8f9905e5ca0e43572037c95204c5403a2
